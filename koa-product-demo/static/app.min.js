!function(e){"use strict";angular.module("Ali1688Sdk",[]).factory("Ali1688Auth",["$q",function(e){var r=_.extend({data:{},save:function(r){return e.when(t.objectStore("cache_data").put(r,"ali1688authInfo"))}});return e.when(t.objectStore("cache_data").get("ali1688authInfo")).then(function(e){r.data=e}),r}]).directive("ali1688LoginBtn",["$q","$http","Ali1688Auth",function(t,r,a){return{restrict:"AE",replace:!1,link:function(t,n){n.click(function(){e.document.ali1688LoginSuccess=null,r.post("/call/Ali1688Sdk.getLoginUrl",{}).then(function(t){e.open(t.data);e.document.ali1688LoginSuccess=function(t){a.save(t).then(function(){e.document.ali1688LoginSuccess=null,a.data=t})}})})}}}]).run(["$rootScope","Ali1688Auth",function(e,t){e.Ali1688Auth=t}]),angular.module("AliexpressSdk",[]).factory("AliexpressAuth",["$q",function(e){var r=_.extend({data:{},save:function(r){return e.when(t.objectStore("cache_data").put(r,"aliexpressauthInfo"))}});return e.when(t.objectStore("cache_data").get("aliexpressauthInfo")).then(function(e){r.data=e}),r}]).directive("aliexpressLoginBtn",["$q","$http","AliexpressAuth",function(t,r,a){return{restrict:"AE",replace:!1,link:function(t,n){n.click(function(){e.document.aliexpressLoginSuccess=null,r.post("/call/AliexpressSdk.getLoginUrl").then(function(t){console.log(t);e.open(t.data);e.document.aliexpressLoginSuccess=function(t){a.save(t).then(function(){e.document.aliexpressLoginSuccess=null,a.data=t})}})})}}}]).run(["$rootScope","AliexpressAuth",function(e,t){e.AliexpressAuth=t}]),angular.module("SuMaiTong",["pascalprecht.translate","ngSanitize","ui.router","ngMessages","Ali1688Sdk","AliexpressSdk"]).config(["$locationProvider","$urlRouterProvider","$translateProvider",function(e,t){t.otherwise("/site")}]),angular.module("SuMaiTong").config(["$httpProvider",function(e){e.interceptors.push(["$q",function(){return{request:function(e){return e.data||(e.data={}),e},response:function(e){return e}}}])}]);var t=$.indexedDB("smt",{version:1,upgrade:function(){},schema:{1:function(e){e.deleteObjectStore("cache_data");e.createObjectStore("cache_data",{keyGenerator:"_id"})},2:function(){}}});angular.module("SuMaiTong").controller("Ali1688AdminCtrl",["$scope","$state","ApiManage","$q","KtPager","KtAlert",function(e,t,r,a,n){e.KtPager=new n(10,8),e.search={page:t.params.page||1,subject:t.params.subject||"",postCategryId:t.params.postCategryId||null},e.KtPager.cur_page=e.search.page,e.products=[],r.get("ali1688.getList",e.search).then(function(t){e.products=t.products,e.KtPager.setTotal(t.total)}),e.KtPager.onSelected=function(r){e.search.page=r,t.go("ali1688.admin",e.search)},e.toSearch=function(){e.search.page=1,t.go("ali1688.admin",e.search)},e.addToMyproduct=function(e){r.get("Myproduct.createByAli1688Id",e._id).then(function(e){console.log(e)})},e.regether=function(e){r.get("Ali1688.getherDataBy1688Id",e.offerId).then(function(t){console.log(t),angular.forEach(t,function(t,r){e[r]=t})})}}]),angular.module("SuMaiTong").controller("Ali1688GatherCtrl",["$scope","$state","ApiManage","$q",function(r,a,n,o){function i(e){for(var t,r=new RegExp(/offer\/([\d]*).*/gi),a=[];null!==(t=r.exec(e));)a.push(t[1]);return _.uniq(a)}r.urls=e.localStorage.gather_urls||"http://detail.1688.com/offer/1244183533.html\r\nhttp://detail.1688.com/offer/1178914841.html",r.gatherDataByUrls=function(){r.gather_progress=[];var t=i(r.urls);e.localStorage.gather_urls=r.urls,angular.forEach(t,function(e){n.get("Ali1688.getherDataBy1688Id",e).then(function(t){return r.gather_progress.push(e+" 采集完成"),console.log(t),t})["catch"](function(e){console.log(e," err")})})},r.gatherProductByOrders=function(){r.gather_progress=[],o.when(t.objectStore("cache_data").get("ali1688authInfo")).then(function(e){return n.get("Ali1688.gatherProductBy1688Orders",{buyerMemberId:e.memberId,access_token:e.access_token,pageNO:1,pageSize:20})}).then(function(){r.gather_progress.push("已买到的产品采集完成")})},r.member_id="sll0510",r.gatherProductByMemberId=function(){r.gather_progress=[];var e=[];o.when(t.objectStore("cache_data").get("ali1688authInfo")).then(function(){return n.get("Ali1688.gatherProductTotalBy1688MemberId","手链",r.member_id)}).then(function(t){for(var a=Math.ceil(t.data/50),i=[];a>=0;)i.push(a+1),a--;return _.each(i,function(t){var a=n.get("Ali1688.gatherProductBy1688MemberId","手链",r.member_id,t).then(function(){r.gather_progress.push("第"+t+"页采集完成")});e.push(a)}),o.all(e)})}}]),angular.module("SuMaiTong").controller("AliexpressAdminCtrl",["$scope","$state","ApiManage","$q","KtPager","KtAlert",function(e,r,a,n,o){var i=JSON.parse(r.params.q||"{}");e.KtPager=new o(10,8),e.search={query:i.query,page:i.page||1,postCategryId:i.postCategryId||null},e.KtPager.cur_page=e.search.page,e.products=[],a.get("Aliexpress.getList",e.search).then(function(t){e.products=t.products,e.KtPager.setTotal(t.total)}),e.KtPager.onSelected=function(t){e.search.page=t,r.go("aliexpress.admin",{q:JSON.stringify(e.search)})},e.toSearch=function(){e.search.page=1,r.go("aliexpress.admin",{q:JSON.stringify(e.search)})},e.syncByPid=function(e){n.when(t.objectStore("cache_data").get("aliexpressauthInfo")).then(function(t){return a.get("Aliexpress.syncByPid",e,t.access_token)}).then(function(e){console.log(e)})["finally"]()},e.syncAllToLocal=function(){var e;n.when(t.objectStore("cache_data").get("aliexpressauthInfo")).then(function(t){return e=t.access_token,n.all([a.get("Aliexpress.gatherIds","onSelling",e),a.get("Aliexpress.gatherIds","offline",e),a.get("Aliexpress.gatherIds","auditing",e),a.get("Aliexpress.gatherIds","editingRequired",e)])}).then(function(t){console.log("所有产品ID已得到，正在同步产品详情……");var r=_.union.apply(_,t),n=[];return _.each(r,function(t){var r=a.get("Aliexpress.syncByPid",t,e).then(function(e){e.error_code?console.log(t+" 同步失败",e):console.log(e.subject+" 完成")});n.push(r)}),Q.all(n)}).then(function(){console.log("同步完成"),r.reload()})["finally"]()},e.del=function(e){a.get("Aliexpress.del",e).then(function(){r.reload()})},e.getMyproductByAliexpress=function(e){a.get("Myproduct.findOne",{aliexpress_id:e._id}).then(function(t){return e.Myproduct=t,a.get("Ali1688.findOne",{_id:t.source_of_ali1688_id||""})}).then(function(t){e.source_of_ali1688=t}),a.get("Product.findOne",{aliexpress_productId:e.productId}).then(function(t){return t?a.get("Ali1688.findOne",{offerId:t.ali1688.offerId}).then(function(t){return e.source_of_ali1688=t,a.post("Myproduct.update",{source_of_ali1688_id:t._id},{aliexpress_id:e._id})}).then(function(t){e.Myproduct=t}):void 0})}}]),angular.module("SuMaiTong").controller("AliexpressProductFormCtrl",["$scope","$state","ApiManage","$q",function(e,t,r){function a(e,t){var r=[];return angular.forEach(t,function(t){e.filter(function(e){if(e.attrNameId==t.id)if("check_box"==t.attributeShowTypeValue)angular.forEach(t.values,function(t){t.id==e.attrValueId&&(t.is_selected=!0)});else if("list_box"==t.attributeShowTypeValue)t.selectedValue=e.attrValueId;else if(t.units){var r=e.attrValue.split(" ");t.selectedValue=r}else t.selectedValue=e.attrValue})}),e.filter(function(e){e.attrName&&r.push(e)}),{category_attrs:t,custom_attrs:r}}function n(e,t){var r=[];return angular.forEach(e,function(e){if(e.sku===!0)return!1;if("check_box"==e.attributeShowTypeValue)angular.forEach(e.values,function(t){t.is_selected===!0&&r.push({attrNameId:e.id,attrValueId:t.id})});else if("list_box"==e.attributeShowTypeValue){if(e.selectedValue){var t;e.values.filter(function(r){r.id==e.selectedValue&&(t=r)}),r.push({attrNameId:e.id,attrValueId:e.selectedValue})}}else e.units?e.selectedValue&&r.push({attrNameId:e.id,attrValue:e.selectedValue.join(" ")}):e.selectedValue&&r.push({attrNameId:e.id,attrValue:e.selectedValue})}),angular.forEach(t,function(e){r.push(e)}),r}e.category_attrs=[],e.sku_attrs=[],e.product_custom_attrs={},e.aeopAeProductSKUs={},e.$on("edit.product",function(t,n){e.product_data=n,r.get("AliexpressCate.detailByCateId",n.categoryId).then(function(t){var r=a(n.aeopAeProductPropertys,t.cate_attrs);e.product_custom_attrs=r.custom_attrs,e.category_attrs=r.category_attrs,e.sku_attrs=t.cate_skus,e.select_skus=n.aeopAeProductSKUs})}),e.submit=function(){var t=n(e.category_attrs,e.product_custom_attrs);e.product_data.aeopAeProductPropertys=t,console.log(e.product_data)}}]),angular.module("SuMaiTong").controller("CategoryAdminCtrl",["$scope","$state","ApiManage",function(e,t,r){e.form_is_shown=!1,e.categoryId=null,e.activeModel=null,e.models=[],r.get("AliCateConf.getList").then(function(t){e.models=t}),e.getProductCount=function(e){r.get("Ali1688.count",{postCategryId:e.ali1688_cate_id}).then(function(t){e.product_count=t.data})},e.willSelectModel=function(a){e.form_is_shown=!0,e.save=function(){e.form_is_shown=!1,a.aliexpress_cate_id=e.categoryId,r.post("AliCateConf.save",a).then(function(e){a.aliexpress_cate_id=e.aliexpress_cate_id,t.reload()})}},e.gatherByProducts=function(){r.get("AliCateConf.extractionAttrsToConfByAll1688Product").then(function(){t.reload()})}}]),angular.module("SuMaiTong").controller("CategoryAttrConfigCtrl",["$scope","$state","ApiManage","KtAlert",function(e,t,r,a){var n=Number(t.params.cateId),o={};e.ref_cates=[],r.get("AliexpressCate.detailByCateId",n).then(function(t){return t.cate_attrs.push({names:{zh:"无效属性"},id:0}),e.aliexress_attrs=t.cate_attrs,r.get("AliCateConf.detailByAliexpressCid",n)}).then(function(t){o=t,e.aliexpress_cate_configs=t.conf_info})["catch"](function(e){console.log("出错了",e)}),e.onSelectedAttr=function(t,r){e.ref_cates[r]=null,e.aliexress_attrs.filter(function(a){a.id==t.ref_cate_id&&(e.ref_cates[r]=a,t.attributeShowTypeValue=a.attributeShowTypeValue,t.ref_cate=a)})},e.saveAttrsConfig=function(){r.post("AliCateConf.save",o).then(function(){console.log("保存成功"),a.success("保存成功")})},e.value2string=function(e){return String(e.replace(".","0"))}}]),angular.module("SuMaiTong").controller("DemoCtrl",["$scope","$state","AlibabaProductModel","AliexpressProductManage","AlibabaCategryModel",function(e,t,r,a,n){r.getProductById("1244183533").then(function(e){return console.log("阿里巴巴",e),n.getCategryPathById(e.postCategryId)}).then(function(e){console.log("阿里巴巴分类：",e)}),r.getProductListBySearch({memberId:"mingyangpd3",pageSize:30}).then(function(e){console.log("阿里巴巴列表",e,e.toReturn.length)}),a.getProductById("32250823981").then(function(e){console.log("速卖通",e)})}]),angular.module("SuMaiTong").controller("HeaderCtrl",["$scope","$state",function(){}]),angular.module("SuMaiTong").controller("MyproductAdminCtrl",["$scope","$state","ApiManage","$q","KtPager","KtAlert",function(e,r,a,n,o,i){var u=JSON.parse(r.params.q||"{}");e.KtPager=new o(10,8),e.search={query:u.query,page:u.page||1,postCategryId:u.postCategryId||null},e.KtPager.cur_page=e.search.page,e.products=[];var s=a.get("Myproduct.getList",e.search).then(function(t){e.products=t.products,e.KtPager.setTotal(t.total)}).then(function(){var t=[];return _.each(e.products,function(e){t.push(a.get("Ali1688.findOne",{_id:e.source_of_ali1688_id||"xxx"}).then(function(t){e.source_of_ali1688=t}))}),n.all(t)});e.KtPager.onSelected=function(t){e.search.page=t,r.go("myproduct.admin",{q:JSON.stringify(e.search)})},e.toSearch=function(){e.search.page=1,r.go("myproduct.admin",{q:JSON.stringify(e.search)})},e.createAliexpress=function(e){return n.when(t.objectStore("cache_data").get("aliexpressauthInfo")).then(function(t){return a.get("createAliexpressByMyproduct.createAliexpress",e._id,t.access_token)}).then(function(t){e.aliexpress_id=t._id,e.aliexpress=t,i.success("生成成功")})},e.save=function(e){a.post("Myproduct.update",{_id:e._id},angular.copy(e)).then(function(e){i.success("保存成功"),r.reload(),console.log(e)})},e.aliexpressSave=function(e){return a.post("Aliexpress.update",{_id:e._id},e).then(function(t){return t._id?(e.productId=t.productId,void i.success("保存成功")):i.error("保存出错")})},e.aliexpressPut=function(e){return n.when(t.objectStore("cache_data").get("aliexpressauthInfo")).then(function(t){return a.post("Aliexpress.putProduct",e._id,t.access_token)}).then(function(t){return console.log(t),t._id?(e.productId=t.productId,void i.success("发布成功")):i.error("发布出错")})},s.then(function(){})["finally"]()}]),angular.module("SuMaiTong").controller("ProductAdminCtrl",["$scope","$state","ApiManage","$q","KtPager","KtAlert",function(e,r,a,n,o,i){e.KtPager=new o(10,8),e.search={page:r.params.page||1,subject:r.params.subject||"",postCategryId:r.params.postCategryId||null},e.KtPager.cur_page=e.search.page,e.products=[],a.get("Product.getList",e.search).then(function(t){e.products=t.products,e.KtPager.setTotal(t.total)}),e.KtPager.onSelected=function(t){e.search.page=t,r.go("product.admin",e.search)},e.toSearch=function(){e.search.page=1,r.go("product.admin",e.search)},e.createSmt=function(e){a.get("AutoCreateAliexpressBy1688.run",e._id).then(function(t){console.log(t),angular.forEach(t,function(t,r){e[r]=t})})},e.put=function(e){var r;n.when(t.objectStore("cache_data").get("aliexpressauthInfo")).then(function(t){return r=t.access_token,e.aliexpress_productId?e:(console.log("正在上传图片"),a.post("Product.uploadImages",e._id,r))}).then(function(){return a.post("Product.putProduct",e._id,r)}).then(function(t){return console.log(t),t.error?("13001024"==t.error.error_code&&(e.aliexpress_productId="",a.post("Product.bindAliexpressId",e._id,e.aliexpress_productId)),i.error(t.error.error_message)):(angular.forEach(t,function(t,r){e[r]=t}),void i.success("发布成功"))})["catch"](function(e){return i.error(res)})},e.bindSmtId=function(e){return a.post("Product.bindAliexpressId",e._id,e.aliexpress_productId)}}]),angular.module("SuMaiTong").controller("ProductUpdateCtrl",["$scope","$state","ApiManage","$q",function(t,r,a){t.product={},a.get("Product.detail",r.params._id).then(function(e){console.log(e),t.product=e,t.setEdit(e.aliexpress_zh)}),t.bindSmtId=function(e){return a.post("Product.bindAliexpressId",e._id,e.aliexpress_productId)},t.setEdit=function(e){t.$broadcast("edit.product",e)},t.windowEdit=function(t){var r="http://posting.aliexpress.com/wsproduct/edit_wholesale_product.htm?productId="+t.aliexpress_en.productId,a=e.open(r);a.window.location.href=r}}]),angular.module("SuMaiTong").controller("SidebarCtrl",["$scope","$state",function(){}]),angular.module("SuMaiTong").directive("aliexpressCateSelect",["ApiManage","$q","$translate",function(e){return{require:["^form","ngModel"],restrict:"AE",replace:!0,templateUrl:"templates/directives/aliexpressCateSelect.html",scope:{name:"@"},link:function(t,r,a,n){var o=(t._form=n[0],t._input=n[1]);o.$render=function(){},t.selects=[],t.categorys=[],t.selected_id=0,t.onSelectedItem=function(e){var r=t.selects[e];Boolean(r.isleaf)===!0?(t.selected_id=r.id,o.$setViewValue(r.id),t.selects[e+1]=null):(t.selects[e+1]=t.selects[e].childs[0],t.onSelectedItem(e+1))},e.get("Cache.get","AliexpressCates").then(function(e){t.categorys=e,t.selects[0]=e[0],t.onSelectedItem(0)})}}}]),angular.module("SuMaiTong").factory("KtAlert",["$compile","$rootScope","$timeout","$translate",function(e,t,r,a){function n(n){function o(){u.$destroy(),p.remove()}var i=a.instant(String(n.message)),u=t.$new(),s="<div kt-alert-"+n.status+">"+i+"</div>",l=e(s),c=l(u),p=$('<div class="kt-alert-server"></div>').append(c);u.alertClose=o,r(function(){p.appendTo("body"),c.css({position:"absolute",top:100,left:.5*($("body").width()-c.width())}),c.find(".kt-alert-message-closebtn").click(function(){u.$apply(function(){o()})})},360),r(function(){o()},3e3)}return{success:function(e){n({status:"success",message:e})},error:function(e){n({status:"error",message:e})},warning:function(e){n({status:"warning",message:e})}}}]).directive("ktAlertSuccess",[function(){return{restrict:"AE",replace:!0,templateUrl:"templates/directives/kt_alert.html",transclude:!0,scope:{},link:function(e,t){e.status="success",e.alertClose=function(){console.log("ktAlertSuccess alertClose"),e.$destroy(),t.remove()}}}}]).directive("ktAlertError",[function(){return{restrict:"AE",replace:!0,templateUrl:"templates/directives/kt_alert.html",transclude:!0,scope:{},link:function(e,t){e.status="error",e.alertClose=function(){e.$destroy(),t.remove()}}}}]).directive("ktAlertWarning",[function(){return{restrict:"AE",replace:!0,templateUrl:"templates/directives/kt_alert.html",transclude:!0,scope:{},link:function(e,t){e.status="warning",e.alertClose=function(){e.$destroy(),t.remove()}}}}]),angular.module("SuMaiTong").factory("KtPager",[function(){function e(){var e=this.total,t=this.page_size,r=this.tag_count,a=this.max_page=Math.ceil(parseInt(e)/parseInt(t)),n=1,o=a,i=Math.ceil(.5*parseInt(r))-1,u=Math.ceil(.5*parseInt(r));this.cur_page=parseInt(this.cur_page),this.is_shown=a>1?!0:!1,this.page_items=[],n=this.cur_page-i,o=this.cur_page+u,1>n&&(n=1);var s=a-r;n>s&&s>0&&(n=s);var l=r;l>o&&(o=l),o>a&&(o=a);for(var c=n;o>=c;)this.page_items.push({number:c}),c++}return function(t,r){this._generateUiData=e,this.total=0,this.page_size=t||10,this.tag_count=r||5,this.cur_page=1,this.is_shown=!1,this.max_page=0,this.page_items=[],this.onSelected=function(){},this.setPage=function(e){return e==this.cur_page?!1:(1>e&&(e=1),e>this.max_page&&(e=this.max_page),this.cur_page=e,this._generateUiData(),void this.onSelected(e))},this.setTotal=function(e){this.total=Number(e),this._generateUiData()},this.init=function(){this._generateUiData()}}}]).directive("ktPager",["KtPager",function(e){return{restrict:"AE",templateUrl:"templates/directives/kt_pager.html",scope:{pageModel:"=ktPager"},link:function(t){t.pageModel||(t.pageModel=new e),t.pageModel.init()}}}]),angular.module("SuMaiTong").directive("viewToEdit",["$parse","$timeout",function(e,t){return{restrict:"AE",replace:!0,templateUrl:"templates/directives/view_to_edit.html",scope:{value:"=viewToEdit",onBlur:"&"},link:function(e,r){var a=$(r).find(".view-to-edit-show"),n=$(r).find("input:first");e.is_edit=!1,a.click(function(){n.css({width:a.eq(0).width(),minWidth:30}),e.$apply(function(){e.is_edit=!0})}),n.blur(function(){e.$apply(function(){e.is_edit=!1,e.onBlur&&t(function(){e.onBlur()},300)})})}}}]),angular.module("SuMaiTong").filter("AliexpressProductLabel",["AliexpressProductManage","$sce",function(e,t){var r=e;return function(e){var a=r.fields[e];return t.trustAsHtml(a.label+'(<span style="color:#999">'+e+"</span>)")}}]),angular.module("SuMaiTong").config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/ali1688","/ali1688/admin"),e.state("ali1688",{url:"/ali1688",views:{container:{templateUrl:"templates/ali1688/layout.html"}}}).state("ali1688.gather",{url:"/gather",views:{container:{templateUrl:"templates/ali1688/gather.html"}}}).state("ali1688.admin",{url:"/admin?page&subject&postCategryId",views:{container:{templateUrl:"templates/ali1688/admin.html"}}})}]),angular.module("SuMaiTong").config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/aliexpress","/aliexpress/admin"),e.state("aliexpress",{url:"/aliexpress",views:{container:{templateUrl:"templates/aliexpress/layout.html"}}}).state("aliexpress.admin",{url:"/admin?q",views:{container:{templateUrl:"templates/aliexpress/admin.html"}}}).state("aliexpress.create",{url:"/create",views:{container:{templateUrl:"templates/aliexpress/update.html"}}}).state("aliexpress.update",{url:"/update/:_id",views:{container:{templateUrl:"templates/aliexpress/update.html"}}}).state("aliexpress.detail",{url:"/detail",views:{container:{templateUrl:"templates/aliexpress/update.html"}}})}]),angular.module("SuMaiTong").config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/category","/category/admin"),e.state("category",{url:"/category",views:{container:{templateUrl:"templates/category/category_layout.html"}}}).state("category.admin",{url:"/admin",views:{container:{templateUrl:"templates/category/category_admin.html"}}}).state("category.attrconfig",{url:"/attrconfig/:cateId",views:{container:{templateUrl:"templates/category/category_attr_config.html"}}})}]),angular.module("SuMaiTong").config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/myproduct","/myproduct/admin"),e.state("myproduct",{url:"/myproduct",views:{container:{templateUrl:"templates/myproduct/layout.html"}}}).state("myproduct.admin",{url:"/admin?q",views:{container:{templateUrl:"templates/myproduct/admin.html"}}}).state("myproduct.create",{url:"/create",views:{container:{templateUrl:"templates/myproduct/update.html"}}}).state("myproduct.update",{url:"/update/:_id",views:{container:{templateUrl:"templates/myproduct/update.html"}}}).state("myproduct.detail",{url:"/detail",views:{container:{templateUrl:"templates/myproduct/update.html"}}})}]),angular.module("SuMaiTong").config(["$stateProvider","$urlRouterProvider",function(e,t){t.when("/product","/product/admin"),e.state("product",{url:"/product",views:{container:{templateUrl:"templates/product/product_layout.html"}}}).state("product.admin",{url:"/admin?page&subject&postCategryId",views:{container:{templateUrl:"templates/product/product_admin.html"}}}).state("product.create",{url:"/create",views:{container:{templateUrl:"templates/product/product_update.html"}}}).state("product.update",{url:"/update/:_id",views:{container:{templateUrl:"templates/product/product_update.html"}}}).state("product.detail",{url:"/detail",views:{container:{templateUrl:"templates/product/product_update.html"}}})}]),angular.module("SuMaiTong").config(["$stateProvider","$urlRouterProvider",function(e){e.state("site",{url:"/site",views:{container:{templateUrl:"templates/dashboard.html"}}})}]),angular.module("SuMaiTong").config(["$stateProvider","$urlRouterProvider",function(e){e.state("user",{url:"/user",views:{appContainer:{templateUrl:"templates/layouts/user_layout.html"}}}).state("user.login",{url:"/login",views:{container:{templateUrl:"templates/user_login.html"}}}).state("user.signup",{url:"/signup/:id",views:{container:{templateUrl:"templates/user_signup.html"}}})}]),angular.module("SuMaiTong").factory("AlibabaAuthManage",["$timeout","$http",function(t,r){function a(e,t){for(var r="",a=[],n=e.split("&"),o=0;o<n.length;o++){var i=n[o].indexOf("=");a.push(i>0?n[o].substring(0,i)+n[o].substr(i+1):n[o])}a.sort(),r+=a.join("");var u=Crypto.HMAC(Crypto.SHA1,r,t,{asBytes:!0}),s=Crypto.util.bytesToHex(u);return[r,s.toUpperCase()]}function n(){var t="http://gw.open.1688.com/auth/authorize.htm",r="client_id="+p+"&site="+g+"&redirect_uri="+f;h.length>0&&(r+="&state="+h),m.length>0&&(r+="&scope="+m);var n=a(r,d),o=r+"&_aop_signature="+n[1],i=Q.defer();return y=_.Window.get(e.open(t+"?"+o)),y.on("loaded",function(){if(this.title.indexOf("code")>=0){var e=this.window.location.href.split("code=");e&&e[1]?i.resolve(e[1]):i.reject("验证失败")}}),i.promise}function o(e){var t="https://gw.open.1688.com/openapi/http/1/system.oauth2/getToken/"+p,a={};return a.client_id=p,a.redirect_uri=f,a.code=e,a.client_secret=encodeURIComponent(d),a.grant_type="authorization_code",a.need_refresh_token="true",r({url:t,data:$.param(a),method:"POST",responseType:"json",timeout:8e3}).then(function(e){return console.log("getToken data:",e),y.close(),e.data})}function i(){return"string"==typeof b?Q.fcall(function(){return!0}):n().then(function(e){return o(e)}).then(function(t){return v=e.localStorage.alibaba_username=t.resource_owner,b=e.localStorage.alibaba_access_token=t.access_token,S=e.localStorage.alibaba_memeber_id=t.memberId,I=e.localStorage.alibaba_refresh_token_timeout=t.refresh_token_timeout,!0})}function u(){e.localStorage.removeItem(alibaba_username),e.localStorage.removeItem(alibaba_access_token),e.localStorage.removeItem(alibaba_memeber_id),e.localStorage.removeItem(alibaba_refresh_token_timeout)}function s(e,t){var r="param2/1/cn.alibaba.open/"+e+"/"+p,a=r,n=[];for(var o in t)t[o]&&n.push(String(o)+t[o]);n.sort(),a+=n.join("");var i=Crypto.HMAC(Crypto.SHA1,a,d,{asBytes:!0}),u=Crypto.util.bytesToHex(i),s=[a,u.toUpperCase()];return s}function l(e){var t="param2/1/cn.alibaba.open/"+e.api_name+"/"+p,a=c+t;if(e.data){e.data.access_token=b;var n=s(e.api_name,e.data);e.data._aop_signature=n[1]}else{e.params.access_token=b;var n=s(e.api_name,e.params);e.params._aop_signature=n[1]}return r({method:e.method||"GET",url:a,params:e.params||null,data:e.data||null})}var c="http://gw.open.1688.com/openapi/",p="1016528",d="f9AnShmLUKj",f="urn:ietf:wg:oauth:2.0:oob",g="china",h="smt",m="",_={},y=null,v=e.localStorage.alibaba_username,b=e.localStorage.alibaba_access_token,S=e.localStorage.alibaba_memeber_id,I=e.localStorage.alibaba_refresh_token_timeout;return{appKey:p,request_url:c,getCode:n,getToken:o,login:i,clear:u,username:v,access_token:b,memeber_id:S,_apiSignature:s,http:l}}]),angular.module("SuMaiTong").factory("AlibabaCateManage",["$q","AlibabaAuthManage",function(e,r){function a(t){var a={categoryID:t};return r.http({method:"GET",api_name:"category.getCatePath",params:a}).then(function(t){var r,a=t.data.result,n=[],i={},u=e.defer();return r=a.toReturn.length,$.each(a.toReturn,function(e,t){n.push(t.catsName)}),i=a.toReturn[r-1],i.path=n.join(" / "),i.isLeaf=i.leaf,o.add(i).then(function(e){u.resolve(e)}).fail(function(e,t){u.reject(t)}),u.promise})}var n={},o=t.objectStore("alibaba_category");n.store=o;return n.gatherCategoryPathByCid=a,n.gatherCateAttrsByCid=function(e){var t={categoryID:e};return r.http({method:"GET",api_name:"productAttributes.get",params:t}).then(function(e){return e.data.result.toReturn})},n.findAll=function(){var t=e.defer(),r=[];return o.each(function(e){r.push(e.value)},null,"prev").then(function(){t.resolve(r)}).fail(function(e,r){t.reject(r)}),t.promise},n.extractByProducts=function(){var r=e.defer(),n=[],i=t.objectStore("my_product");return i.index("alibaba_postCategryId_idx").each(function(e){o.index("catsId").get(e.value.alibaba.postCategryId).then(function(t){if("undefined"==typeof t){var r=a(e.value.alibaba.postCategryId);n.push(r)}}).fail(function(e,t){console.log(t)})}).then(function(){return e.all(n)}).then(function(e){r.resolve(e)}).fail(function(e,t){r.reject(t)}),r.promise},n.getAliexpressIdByCatsId=function(t){var r=e.defer();return o.index("catsId").get(t).then(function(e){r.resolve(e.aliexpress_cate_id)}).fail(function(e,t){r.reject(t)}),r.promise},n}]),angular.module("SuMaiTong").factory("AlibabaProductManage",["$q","AlibabaAuthManage",function(t,r){function a(){var e=[];for(var t in l)e.push(t);return e}function n(e){var t={offerId:e,returnFields:c.join(",")};return r.http({method:"GET",api_name:"offer.get",params:t}).then(function(e){return e.data.result.toReturn[0]})}function o(e){var t={pageNo:1,returnFields:null,pageSize:50,orderBy:null,offerId:null,q:null,isTradeOffer:null,category:null,gmtModifiedBegin:null,gmtModifiedEnd:null,address:null,memberId:null,tpType:null,tpYear:null,creditMoney:null,tradeType:null,soldQuantity:null,showType:null,bizType:null,province:null,city:null,price:null,qualityLevel:null,quantityBegin:null,online:null,groupIds:null,status:null,other:null};for(var a in t)e[a]||(e[a]=t[a]);return r.http({method:"GET",api_name:"offer.search",params:e}).then(function(e){return e.data.result})}function i(t){return t=t||{},r.http({method:"GET",api_name:"trade.order.orderList.get",params:{buyerMemberId:e.localStorage.alibaba_memeber_id,pageNO:t.pageNO||1,pageSize:20}}).then(function(e){return e.data.result})}function u(){var e=[];return i().then(function(t){return angular.forEach(t.toReturn,function(t){angular.forEach(t.orderEntries,function(t){e.push(t.sourceId)})}),_.uniq(e)})}var s={},l={skuPics:["List","否","SKU图片"],isPrivateOffer:["Boolean","否","是否有私密信息"],isPriceAuthOffer:["Boolean","否","是否价格私密"],isPicAuthOffer:["Boolean","否","是否图片私密"],offerId:["long","否","商品ID"],isPrivate:["Boolean","否","是否为私密offer的标志位。true：私密产品 false：普通产品"],detailsUrl:["String","否","商品详情地址"],type:["String","否","商品类型。Sale：供应信息，Buy：求购信息"],tradeType:["Integer","否","贸易类型。1：产品，2：加工，3：代理，4：合作，5：商务服务"],postCategryId:["Integer","否","所属叶子类目ID"],offerStatus:["String","是","状态。auditing：审核中；online：已上网；FailAudited：审核未通过；outdated：已过期；member delete(d)：用户删除；delete：审核删除"],memberId:["String","否","卖家会员ID"],subject:["String","否","商品标题"],details:["String","否","详情说明"],qualityLevel:["String","否","商品信息质量星级( 取值为1到5)。1：一星；2：二星；3：三星；4：四星；5：五星"],imageList:["offerImageInfo[]","否","商品图片列表"],productFeatureList:["productFeatureInfo[]","否","商品属性信息"],isOfferSupportOnlineTrade:["Boolean","否","是否支持网上交易。首先需要类目支持，如果类目支持，需要有价格，供货总量，最小起订量。true：支持网上订购；false：不支持网上订购"],tradingType:["String","否","支持的交易方式。当isOfferSupportOnlineTrade为true的时候本字段有效：Escrow:支付宝担保交易； PreCharge：支付宝预存款交易；ForexPay：支付宝境外支付交易；多种交易方式间通过;分隔。"],isSupportMix:["Boolean","否","是否支持混批。true：支持混批；false：不支持混批"],unit:["String","否","计量单位"],priceUnit:["String","否","交易币种"],amount:["Integer","否","供货量"],amountOnSale:["Integer","否","可售数量"],saledCount:["Integer","否","已销售量"],retailPrice:["double","否","建议零售价"],unitPrice:["double","否","单价"],priceRanges:["priceRangeInfo[]","否","价格区间"],termOfferProcess:["Integer","否","有效期(单位：天)"],freightTemplateId:["Integer","否","物流模板id"],sendGoodsId:["Integer","否","发货地址id"],productUnitWeight:["Integer","否","单位重量"],freightType:["Integer","否","T:运费模板 D：运费说明 F：卖家承担运费"],isSkuOffer:["Boolean","否","是否为SKU商品"],isSkuTradeSupported:["Boolean","否","是否支持按照规格报价"],skuArray:["Map","否",'SKU规格属性信息{fid:value}当有多个值时用"#"联接'],gmtCreate:["String","是","创建日期"],gmtModified:["String","是","最近修改时间"],gmtLastRepost:["String","是","最近重发时间"],gmtApproved:["String","是","审核通过时间"],gmtExpire:["String","是","过期日期"]},c=a();return s.fields=l,s.keys=c,s.gatherProductById=n,s.gatherProductListBySearch=o,s.getAllOrders=i,s.getBuyProductIds=u,s}]),angular.module("SuMaiTong").factory("AliexpressAuthManage",["$timeout","$http",function(t,r){function a(e,t){for(var r="",a=[],n=e.split("&"),o=0;o<n.length;o++){var i=n[o].indexOf("=");a.push(i>0?n[o].substring(0,i)+n[o].substr(i+1):n[o])}a.sort(),r+=a.join("");var u=Crypto.HMAC(Crypto.SHA1,r,t,{asBytes:!0}),s=Crypto.util.bytesToHex(u);return[r,s.toUpperCase()]}function n(){var t="http://gw.api.alibaba.com/auth/authorize.htm",r="client_id="+p+"&site="+g+"&redirect_uri="+f;h.length>0&&(r+="&state="+h),m.length>0&&(r+="&scope="+m);var n=a(r,d),o=r+"&_aop_signature="+n[1],i=Q.defer();return _=gui.Window.get(e.open(t+"?"+o)),_.on("loaded",function(){if(this.title.indexOf("code")>=0){var e=this.window.location.href.split("code=");e&&e[1]?i.resolve(e[1]):i.reject("验证失败")}}),i.promise}function o(e){var t="https://gw.api.alibaba.com/openapi/http/1/system.oauth2/getToken/"+p,a={};return a.client_id=p,a.redirect_uri=f,a.code=e,a.client_secret=encodeURIComponent(d),a.grant_type="authorization_code",a.need_refresh_token="true",r({url:t,data:$.param(a),method:"POST",responseType:"json",timeout:8e3}).then(function(e){return console.log("getToken data:",e),_.close(),e.data})}function i(){return"string"==typeof v?Q.fcall(function(){return!0}):n().then(function(e){return o(e)}).then(function(t){return y=e.localStorage.aliexpress_username=t.resource_owner,v=e.localStorage.aliexpress_access_token=t.access_token,b=e.localStorage.aliexpress_memeber_id=t.memberId,S=e.localStorage.aliexpress_refresh_token_timeout=t.refresh_token_timeout,!0})}function u(){e.localStorage.removeItem("aliexpress_username"),e.localStorage.removeItem("aliexpress_access_token"),e.localStorage.removeItem("aliexpress_memeber_id"),e.localStorage.removeItem("aliexpress_refresh_token_timeout")}function s(e,t){for(var r="param2/1/aliexpress.open/"+e+"/"+p,a=r,n=[],o=$.param(t),i=o.split("&"),u=0;u<i.length;u++){var s=i[u].indexOf("=");n.push(s>0?i[u].substring(0,s)+i[u].substr(s+1):i[u])}n.sort(),a+=n.join("");var l=Crypto.HMAC(Crypto.SHA1,a,d,{asBytes:!0}),c=Crypto.util.bytesToHex(l),f=[a,c.toUpperCase()];return f[1]}function l(e){var t,a="param2/1/aliexpress.open/"+e.api_name+"/"+p,n=c+a;return e.data?(e.data.access_token=v,e.data=$.param(e.data)):(e.params.access_token=v,t=s(e.api_name,e.params),e.params._aop_signature=t),r({method:e.method||"GET",url:n,params:e.params||null,data:e.data||null})}var c="http://gw.api.alibaba.com/openapi/",p="3647787",d="jKMnbD3gs7B",f="urn:ietf:wg:oauth:2.0:oob",g="aliexpress",h="smt",m="",_=null,y=e.localStorage.aliexpress_username,v=e.localStorage.aliexpress_access_token,b=e.localStorage.aliexpress_memeber_id,S=e.localStorage.aliexpress_refresh_token_timeout;
return{appKey:p,request_url:c,getCode:n,getToken:o,login:i,clear:u,username:y,access_token:v,memeber_id:b,http:l}}]),angular.module("SuMaiTong").factory("AliexpressCateManage",["$timeout","$rootScope","$q","AliexpressAuthManage",function(e,r,a,n){function o(){var e=[];for(var t in S)e.push(t);return e}function i(){return u(0)}function u(e){return n.http({method:"GET",api_name:"api.getChildrenPostCategoryById",params:{cateId:e}}).then(function(e){var t=e.data.aeopPostCategoryList;return t})}function s(e){return n.http({method:"GET",api_name:"api.getAttributesResultByCateId",params:{cateId:e}}).then(function(e){return e.data.attributes})}function l(){function t(e){return n++,u(e).then(function(a){var n=a;return angular.forEach(n,function(r){r.parent_id=e||0,r.isleaf===!1&&(r.recursion=function(){return t(r.id).then(function(e){r.childs=e,r.recursion=null})},r.recursion())}),r(),n})["catch"](function(e){i.reject(e)})}function r(){o++,y.sync_progress=["internet",o,n],n==o&&e(function(){i.resolve(s)},500)}var n=0,o=0,i=a.defer(),s=[];return s=t(0),i.promise.then(function(e){return b["delete"]("aliexpress_categorys").then(function(){return b.add(e,"aliexpress_categorys")}).fail(function(e,t){console.log(t)}),e})}function c(e){function t(e){angular.forEach(e,function(e){n++;var a={};for(var o in S)a[o]=e[o]||null,a.isleaf=Number(e.isleaf||null);return e.isleaf===!1&&t(e.childs),v.add(a).then(function(){r()}).fail(function(e){i.reject(e)})})}function r(){o++,y.sync_progress=["inser",o,n],n==o&&i.resolve(u),console.log(y.sync_progress)}var n=0,o=0,i=a.defer(),u=[];return t(e),i.promise}function p(){var e=a.defer();return v.clear().then(function(){e.resolve(!0)}).fail(function(t,r){e.reject(r)}),e.promise.then(function(){return l()}).then(function(e){return c(e)}).then(function(e){return console.log("同步完成"),e})}function d(){var e=0,t=0,r=a.defer();return v.each(function(a){if(a.value.isleaf){e++,y.sync_progress=["同步属性",t,e];{s(a.value.id).then(function(e){return a.value.attributes=e,v.put(a.value)}).then(function(a){return t++,y.sync_progress=["同步属性",t,e],e==t&&(console.log(e,t),r.resolve(!0)),a})["catch"](function(e,t){r.reject(t)})}}}),r.promise.then(function(r){return console.log("同步完成",r),y.sync_progress=["同步属性完成",t,e],r})["catch"](function(e,t){throw t})}function f(){var e=a.defer(),t=[];return v.index("isleaf_idx").each(function(e){e.value.skus=[],e.value.attrs=[],e.value.attributes.filter(function(t){t.sku===!0&&1==t.spec?e.value.skus[0]=t:t.sku===!0&&2==t.spec&&(e.value.skus[1]=t),t.sku===!0&&3==t.spec?e.value.skus[2]=t:e.value.attrs.push(t)}),t.push(e.update(e.value))},1).then(function(){return console.log("........"),a.all(t)}).then(function(){e.resolve(!0)}).fail(function(t,r){e.reject(r)}),e.promise}function g(e){var r=[],n=t.objectStore("aliexpress_category_configs").get(Number(e)).then(function(a){return a||(a={}),t.objectStore("my_product").index("aliexpress_categoryId_idx").each(function(e){r=r.concat(e.value.alibaba.productFeatureList)},Number(e)).then(function(){return angular.forEach(r,function(e){var t=String(e.fid);"undefined"==typeof a[t]?a[t]=e:a[t].values=_.uniq(a[t].values.concat(e.values))}),a})}).then(function(e){return e}).fail(function(e){return e});return a.when(n)}function h(e){var t=a.defer();return v.index("id").get(Number(e)).then(function(e){t.resolve(e)}).fail(function(e,r){console.log(r),t.reject(r)}),t.promise}function m(){var e=a.defer();return b.get("aliexpress_categorys").then(function(t){e.resolve(t)}).fail(function(t,r){e.reject(r)}),e.promise}var y={},v=t.objectStore("aliexpress_category"),b=t.objectStore("cache_data"),S={id:{label:"ID"},isleaf:{label:"是否是叶子类目",type:"Boolean"},level:{label:"类目层级",type:"int"},names:{label:"类目名称",type:"Object"},parent_id:{label:"父类ID"}};return y.sync_progress=[],y.store=v,y.fields=S,y.keys=o(),y.gatherTopCategorys=i,y.gatherChildrenPostCategoryById=u,y.gatherAttributesResultByCateId=s,y.syncCategoryDatas=p,y.syncCategoryAttributes=d,y.separateSkusAttrs=f,y.getCateByCateId=h,y.getCategroysByCache=m,y.getCatesAttrsConfig=g,y}]),angular.module("SuMaiTong").factory("AliexpressProductManage",["$timeout","AliexpressAuthManage","$http","$q",function(e,t,r,a){function n(){var e=this,t=angular.copy(h);return angular.forEach(t,function(t,r){e[r]=t["default"]||null}),this}function o(){return{ipmSkuStock:999,skuCode:"",skuPrice:"",skuStock:!0,aeopSKUProperty:[{propertyValueId:null,skuPropertyId:null,skuImage:null,propertyValueDefinitionName:null}]}}function i(){var e=[];for(var t in h)e.push(t);return e}function u(e){return t.http({method:"GET",api_name:"api.findAeProductById",params:{productId:e}}).then(function(e){return e.data})}function s(e){var r=angular.copy(e);return r.aeopAeProductPropertys=JSON.stringify(r.aeopAeProductPropertys),r.aeopAeProductSKUs=JSON.stringify(r.aeopAeProductSKUs),r.isImageDynamic=!0,r.imageURLs=r.imageURLs.join(";"),t.http({method:"POST",api_name:"api.postAeProduct",data:r}).then(function(e){return e.data})}function l(e){var r=angular.copy(e);return r.aeopAeProductPropertys=JSON.stringify(r.aeopAeProductPropertys),r.aeopAeProductSKUs=JSON.stringify(r.aeopAeProductSKUs),r.isImageDynamic=!0,r.imageURLs=r.imageURLs.join(";"),t.http({method:"POST",api_name:"api.editAeProduct",data:r}).then(function(e){return e.data})}function c(e,t,r,a){var n=a,o=[],i={};return angular.forEach(r,function(t){e.filter(function(e){if(e.attrNameId==t.id)if("check_box"==t.attributeShowTypeValue)angular.forEach(t.values,function(t){t.id==e.attrValueId&&(t.is_selected=!0)});else if("list_box"==t.attributeShowTypeValue)t.selectedValue=e.attrValueId;else if(t.units){var r=e.attrValue.split(" ");t.selectedValue=r}else t.selectedValue=e.attrValue})}),e.filter(function(e){e.attrName&&o.push(e)}),n&&angular.forEach(t,function(e,t){angular.forEach(n,function(t,r){e.aeopSKUProperty&&e.aeopSKUProperty[r]&&t.values.filter(function(t){t.id==e.aeopSKUProperty[r].propertyValueId&&(t.is_selected=!0)})}),i[t]=e}),{category_attrs:r,custom_attrs:o,sku_attrs:n,select_skus:i}}function p(e,t,r){var a=[],n=[];return angular.forEach(e,function(e){if(e.sku===!0)return!1;if("check_box"==e.attributeShowTypeValue)angular.forEach(e.values,function(t){t.is_selected===!0&&n.push({attrNameId:e.id,attrValueId:t.id})});else if("list_box"==e.attributeShowTypeValue){if(e.selectedValue){var t;e.values.filter(function(r){r.id==e.selectedValue&&(t=r)}),n.push({attrNameId:e.id,attrValueId:e.selectedValue})}}else e.units?e.selectedValue&&n.push({attrNameId:e.id,attrValue:e.selectedValue.join(" ")}):e.selectedValue&&n.push({attrNameId:e.id,attrValue:e.selectedValue})}),angular.forEach(t,function(e){n.push(e)}),r&&r[0]&&angular.forEach(r[0].values,function(e){e.is_selected===!0&&a.push(e.aeop)}),{skus:a,propertys:n}}function d(e){var r=a.defer(),n="param2/1/aliexpress.open/api.uploadImage/"+t.appKey,o=t.request_url+n,i=require("request");return i.get(e).pipe(i.post(o,{qs:{access_token:t.access_token,fileName:e.replace(/\?.*$/gi,"")}},function(e,t,a){return e?r.reject(e):void r.resolve(JSON.parse(a))})).on("error",function(e){console.log("图片上传错误",e)}).on("response",function(){}),r.promise}function f(e){var r=a.defer(),n="param2/1/aliexpress.open/api.uploadTempImage/"+t.appKey,o=t.request_url+n,i=require("request");return i.get(e).pipe(i.post(o,{qs:{access_token:t.access_token,srcFileName:e}},function(e,t,a){return e?r.reject(e):void r.resolve(JSON.parse(a))})).on("error",function(e){console.log("图片上传错误",e)}).on("response",function(){}),r.promise}var g={},h={productId:{label:"ID"},detail:{label:"详情"},aeopAeProductSKUs:{label:"颜色价格"},deliveryTime:{label:"备货期","default":7},categoryId:{label:"商品所属类目ID","default":200000298},subject:{label:"商品标题"},keyword:{label:"搜索关键词"},productMoreKeywords1:{label:"关键词一"},productMoreKeywords2:{label:"关键词二"},summary:{label:"简要描述"},groupId:{label:"产品组ID"},promiseTemplateId:{label:"promiseTemplateId"},productPrice:{label:"商品一口价"},freightTemplateId:{label:"运费模版ID"},isImageDynamic:{label:"商品主图图片类型"},imageURLs:{label:"图片URL"},isImageWatermark:{label:"图片是否加水印的标识"},productUnit:{label:"商品单位"},packageType:{label:"打包销售",type:"boolean","default":!1},lotNum:{label:"每包件数"},packageLength:{label:"商品包装长度"},packageWidth:{label:"商品包装宽度"},packageHeight:{label:"商品包装高度"},grossWeight:{label:"商品毛重"},isPackSell:{label:"是否自定义计重"},baseUnit:{label:"baseUnit"},addUnit:{label:"addUnit"},addWeight:{label:"addWeight"},wsValidNum:{label:"商品有效天数","default":14},src:{label:"指此商品发布的来源","default":"ISV"},aeopAeProductPropertys:{label:"商品属性类型"},bulkOrder:{label:"批发最小数量"},bulkDiscount:{label:"批发折扣"}},m={PCS:100000015,"条":100000015},_=i();return g.fields=h,g.keys=_,g.getProductById=u,g.formatProductAeop=c,g.unformatProductAeop=p,g.SkuModel=o,g.puhlishProductToSMT=s,g.updateProductToSMT=l,g.Model=n,g.alibabaUnitMap=m,g.uploadImage=d,g.uploadTmpImage=f,g}]),angular.module("SuMaiTong").factory("ApiManage",["$http","$q",function(e){return{get:function(t){var r=[];return angular.forEach(arguments,function(e,t){t>0&&r.push(e)}),e({method:"GET",responseType:"JSON",url:"/call/"+t,params:{jsondata:JSON.stringify(r)}}).then(function(e){return e.data})},post:function(t){var r=[];return angular.forEach(arguments,function(e,t){t>0&&r.push(e)}),e({method:"POST",responseType:"JSON",url:"/call/"+t,data:r}).then(function(e){return e.data})}}}]),angular.module("SuMaiTong").factory("MyProductManage",["$q","AlibabaProductManage","AliexpressProductManage","AlibabaCateManage","AliexpressCateManage",function(e,r,a,n,o){function i(e,t){var r=Number(t),a=1.5*Number(e)*85,n=(r+a)/6.15;return.7>n?.99:1.2>n?1.59:1.2>n?1.59:1.6>n?1.99:1.9>n?2.49:2.3>n?2.99:2.8>n?3.89:n+2.5}function u(t){{var r=new a.Model;e.defer()}return r.detail=t.details,r.subject=t.subject,r.keyword=t.subject,r.productPrice=i(t.productUnitWeight,Number(t.priceRanges[0].price)),t.productUnitWeight<.2?(r.freightTemplateId=701731738,r.packageLength=1,r.packageWidth=1,r.packageHeight=1):(r.freightTemplateId=700077439,r.packageLength=10,r.packageWidth=10,r.packageHeight=10),r.grossWeight=t.productUnitWeight,r.productUnit=a.alibabaUnitMap[t.unit]||100000015,r.imageURLs=[],t.imageList.filter(function(e){r.imageURLs.push(e.originalImageURI)}),r.aeopAeProductPropertys=[],n.getAliexpressIdByCatsId(t.postCategryId).then(function(e){return r.categoryId=e,o.getCateByCateId(e)}).then(function(n){var o=[];if(r.aeopAeProductSKUs=[],t.isSkuOffer){var u=[];t.skuArray.filter(function(e,o){if(!n.skus[0].values[o])return!0;var s=a.SkuModel();e.price=Number(e.price)>0?e.price:t.priceRanges[0].price,s.skuPrice=String(i(t.productUnitWeight,e.price)),s.aeopSKUProperty[0].propertyValueId=n.skus[0].values[o].id,s.aeopSKUProperty[0].skuPropertyId=n.skus[0].id,s.aeopSKUProperty[0].propertyValueDefinitionName=e.value,t.skuPics&&t.skuPics[e.fid]&&(t.skuPics[e.fid].filter(function(e){for(var t in e)u[t]="http://img.china.alibaba.com/"+e[t]}),e.pic=u[e.value],s.aeopSKUProperty[0].skuImage=e.pic),r.aeopAeProductSKUs.push(s)})}return e.all(o).then(function(){return r})})}var s=t.objectStore("my_product"),l={},c={};return l.fields={alibaba:{type:"object",label:"原始数据"},aliexpress:{type:"object",label:"生成原始SMT的数据"},aliexpress_zh:{type:"object",label:"使用的中文数据"},aliexpress_en:{type:"object",label:"使用的英文数据"}},l.store=s,l.save=function(t){return e.when(s.put(t))},l.loadByPk=function(t){return e.when(s.get(t))},l.loadByAlibabaPid=function(t){return e.when(s.index("alibaba_offerId_idx").get(t)).then(function(e){return e?e:r.gatherProductById(t)}).then(function(e){var t={alibaba:e};return t})},l.loadByAlibabaPUrl=function(t){var r=e.defer(),a=t.match(/offer\/([\d]*).*/);return a&&a[1]?l.loadByAlibabaPid(a[1]):(r.reject("网址错误"),r.promise)},l.gatherProductByOrders=function(){var t=[];return r.getBuyProductIds().then(function(r){return angular.forEach(r,function(e){var r=l.loadByAlibabaPid(e).then(function(e){l.save(e)});t.push(r)}),e.all(t)})},l.findAll=function(){var t=e.defer(),r=[];return s.each(function(e){r.push(e.value)},null,"prev").then(function(){t.resolve(r)}).fail(function(e,r){t.reject(r)}),t.promise},l.alibabaCopyToAliexpress=function(t){return e.when().then(function(){return u(t.alibaba)}).then(function(r){return t.aliexpress=r,e.when(s.put(t))}).then(function(){return t})},l.setProductsAttrs=function(t){var r=[];return e.when().then(function(){return o.getCatesAttrsConfig(t.aliexpress.categoryId)}).then(function(a){return t.aliexpress.aeopAeProductPropertys=[],t.alibaba.productFeatureList.filter(function(e){var n=a[e.fid];if(n&&0===n.ref_cate_id);else if(n&&null===n.ref_cate_id)t.aliexpress.aeopAeProductPropertys.push({attrName:e.name,attrValue:e.value});else if(n&&n.ref_cate_id>0){var o={},i=n.ref[e.value];if(n.ref_cate&&n.ref_cate.units){var u=i.match(/[\d]+/gi)||[];i=u[0]+" "+n.ref_cate.units[0].unitName}i&&(o.attrNameId=n.ref_cate_id,"input"==n.attributeShowTypeValue?o.attrValue=i:o.attrValueId=i);var s;s="checkbox"==n.attributeShowTypeValue?n.ref_cate_id+"|"+i:n.ref_cate_id,_.indexOf(r,s)<0&&i&&(r.push(s),t.aliexpress.aeopAeProductPropertys.push(o))}}),e.when(s.put(t))}).then(function(){return t})},l.copyToAliexpressZh=function(t){return e.when().then(function(){return t.aliexpress_zh=angular.copy(t.aliexpress),e.when(s.put(t))}).then(function(){return t})},l.regularTakeContent=function(e,t,r){var a=new RegExp(t+"[\\s\\S]*"+r),n=e.match(a)||[];return n[0]||e},l.fanyiProductDetail=function(t){var r,a=[];return e.when().then(function(){for(var e=new RegExp(/([\u4E00-\u9FA5]+)/gi);null!==(r=e.exec(t));)a.push(r[1]);return a=_.uniq(a)}).then(function(e){return c.yi(e.join(","))}).then(function(e){var r=e.split(",");return angular.forEach(a,function(e,a){var n=new RegExp(e,"g");t=t.replace(n,r[a])}),t})},l.fanyiProduct=function(t){var r=angular.copy(t.aliexpress_zh);return e.when().then(function(){return t.aliexpress_en=r,c.yi(r.subject).then(function(e){t.aliexpress_en.subject=e})}).then(function(){return c.yi(r.keyword).then(function(e){t.aliexpress_en.keyword=e})}).then(function(){return r.productMoreKeywords1?c.yi(r.productMoreKeywords1).then(function(e){t.aliexpress_en.productMoreKeywords1=e}):!0}).then(function(){return r.productMoreKeywords2?c.yi(r.productMoreKeywords2).then(function(e){t.aliexpress_en.productMoreKeywords2=e}):!0}).then(function(){var a=[],n=[];return r.aeopAeProductPropertys.filter(function(e,t){a[t]=e;var r;e.attrName&&(r=c.yi(e.attrName).then(function(e){a[t].attrName=e}),n.push(r)),e.attrValue&&(r=c.yi(e.attrValue).then(function(r){console.log(e.attrValue,r),a[t].attrValue=r}),n.push(r))}),e.all(n).then(function(){console.log(a),t.aliexpress_en.aeopAeProductPropertys=a})}).then(function(){var a=[],n=[];return r.aeopAeProductSKUs.filter(function(e,t){a[t]=e,a[t].aeopSKUProperty.filter(function(e){if(e.propertyValueDefinitionName){var t=c.yi(e.propertyValueDefinitionName).then(function(t){e.propertyValueDefinitionName=t.replace(/[^\w\d]+/gi," ").substr(0,20)});n.push(t)}})}),e.all(n).then(function(){t.aliexpress_en.aeopAeProductSKUs=a})}).then(function(){return l.fanyiProductDetail(r.detail)}).then(function(e){return l.fanyiProductDetail(e)}).then(function(e){return l.fanyiProductDetail(e)}).then(function(r){return t.aliexpress_en.detail=r,e.when(s.put(t))}).then(function(){return t})},l.uploadIamges=function(t){var r=[],n=[];return e.when().then(function(){return angular.forEach(t.aliexpress_zh.imageURLs,function(e,t){r[t]=a.uploadImage(e).then(function(e){n[t]=e.photobankUrl})}),e.all(r).then(function(){t.aliexpress_zh.imageURLs=n})}).then(function(){r=[];var n=$(t.aliexpress_zh.detail);return n.find("img").each(function(e){var t=this;/.*\.gif.*/i.test(this.src)?$(this).remove():r[e]=a.uploadImage(this.src).then(function(e){t.src=e.photobankUrl})}),e.all(r).then(function(){return $("<div></div>").append(n).html()})}).then(function(n){return t.aliexpress_zh.detail=n,r=[],angular.forEach(t.aliexpress_zh.aeopAeProductSKUs,function(e,t){e.aeopSKUProperty[0].skuImage&&(r[t]=a.uploadTmpImage(e.aeopSKUProperty[0].skuImage).then(function(t){e.aeopSKUProperty[0].skuImage=t.url}))}),e.all(r)}).then(function(){return e.when(s.put(t))}).then(function(){return t})},l.putToSmt=function(t){return t.aliexpress_en.subject=t.aliexpress_en.subject.substr(0,126),t.aliexpress_en.keyword=t.aliexpress_en.keyword.substr(0,126),t.aliexpress_en.productUnit=100000015,e.when().then(function(){return t.aliexpress_en.productId?a.updateProductToSMT(t.aliexpress_en):a.puhlishProductToSMT(t.aliexpress_en)}).then(function(r){return t.aliexpress_en.productId=r.productId,t.aliexpress_zh.productId=r.productId,t.aliexpress_productId=r.productId,e.when(s.put(t))}).then(function(){return t})},l}])}(window);